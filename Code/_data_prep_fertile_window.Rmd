---
title: "Data Preparation: Identifying the fertile window from temperature, mucus, bleeding and OPK tests"
author: "Laura Symul"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  bookdown::html_document2: 
    theme: flatly
    highlight: haddock
    toc: yes
    toc_float: true
    toc_depth: 5
    number_sections: true
    fig_caption: true
---


```{r data_prep_FW setup, include = FALSE, eval = TRUE, cache = FALSE}
source("Scripts/00_setup.R")
```

```{r data_prep_FW knitr options}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```



# Identifying the fertile window from temperature, mucus, bleeding and OPK tests

Similar framework as in "Assessment of menstrual health status and evolution through mobile apps for fertility awareness":
an HMM is used to identify the different phases of the menstrual cycle from the tracking records of the users.

However, here, we will define a semi-Markov model.

## Semi Markov model

```{r child = '_HsMm_model.Rdm', cache=TRUE}
```


## Preparing the data for the semi-Markov model

### Converting tracked data into [0,1] scores

```{r child = '_functions_to_prepare_data_for_semi_markov.Rdm', cache=TRUE}
```




```{r Preparing data for semi-Markov}

input_folder = paste0(IO$output_data,"Days/")
output_folder = paste0(IO$tmp_data,"Days_with_data_prep_for_semi_markov/")
if(!dir.exists(output_folder)){dir.create(output_folder)}
days_files = list.files(input_folder)

foreach(file = days_files) %do% {
  cat(file, "\n")
  days = read_feather(paste0(input_folder,file))
  #augmented_days = prepare_days(days) #slower
  
  user_ids = unique(days$user_id)
  tic()
  augmented_days = foreach(user = user_ids, .combine = rbind) %do%{
    #cat(user,"\n")
    j = which(days$user_id == user)
    d = days[j,]
    augmented_d = prepare_days(d)
    return(augmented_d)
  }
  toc()
  
  write_feather(augmented_days, path = paste0(input_folder, file))
  file.copy(from = paste0(input_folder, file), to = paste0(output_folder, file), overwrite = TRUE)
}

```


### Formatting the days to long format


```{r days in long format}

input_folder = paste0(IO$output_data,"Days/")
output_folder = paste0(IO$output_data,"Days_long/")
if(!dir.exists(output_folder)){dir.create(output_folder)}
days_files = list.files(input_folder)

foreach(file = days_files)%do%{
  tic()
  cat(file, "\n")
  days_wide = read_feather(paste0(input_folder,file))
  
  id_var = c("user_id","date","day_id", "cycle_id","cycle_nb","cycle_length","cycleday","cycleday_from_end")
  value_var = 
    c("first_day","sex","bleeding","temp","mucus_score","mucus","preg_test","LH","anylog", "gap") #"mucus_tracked"
  var = c(id_var, value_var)
  days = melt(as.data.frame(days_wide[,var]),id.vars = id_var)
  # we remove all the "NA" values
  j = which(is.na(days$value)) 
  if(length(j)>0){days = days[-j,]}
  # also some of the variables where 0 means no log
  j = which( ((days$variable == "sex") & (days$value == 0)) |
               ((days$variable == "first_day") & (days$value == 0)) |
               ((days$variable == "preg_test") & (days$value == 0)) |
               ((days$variable == "LH") & (days$value == 0)) 
  )
  if(length(j)>0){days = days[-j,]}
  
  write_feather(days, path = paste0(output_folder, file))
  toc()
}

```




## Predicting menstrual and pregnancy phases with semi-Markov


```{r load cycles data}
cycles = read_feather(path = paste0(IO$output_data,"cycles.feather"))
```


### Fit model on concatenated time series

```{r concatenating times series of ~500 users that have logged at least 4 cycles}

file_obs = paste0(IO$tmp_data,"concatenated_time_series_to_fit_hsmm.feather")

if(!file.exists(file_obs) | FALSE){
  
  input_folder = paste0(IO$output_data,"Days_long/")
  days_files = sample(list.files(input_folder),10)
  
  obs = foreach(file = days_files, .combine = rbind)%do%{
    cat(file, "\n")
    days = read_feather(paste0(input_folder,file))
    user_ids = sample(unique(days$user_id), 100)
    agg = aggregate(value ~ user_id, days[which((days$variable == "first_day") & (days$user_id  %in% user_ids)),], sum)
    user_ids = agg$user_id[agg$value >= 4]
    
    obs = foreach(user = user_ids, .combine = rbind) %do%{
      j = which(days$user_id == user)
      d = days[j,]
      
      obs = extract_obs(d = d, obs_names = hsmm$obs_names, finish_before_new_cycle = TRUE) 
      return(obs)
    }  
    return(obs)
  }   
  
  dim(obs)
  
  write_feather(obs, path = file_obs)
  full_obs = obs
}

```





```{r fit HSMM on concatenated time series}

full_obs = read_feather(path = file_obs)

k = which(full_obs$first_day == 1)
k = k[1:min(length(k),100)]

obs = full_obs[1:(max(k)-1),]
obs = full_obs[121:225,]

obs$gap_num = obs$gap
obs$gap = 1*(obs$gap_num >= 30)

newdata = list(N  = nrow(obs), x = as.matrix(obs[,match(hsmm$obs_names, colnames(obs))]))


load(file = paste0(IO$output_data,"unfitted_reprod_cycles_model.Rdata"), verbose = TRUE)


tic()
reprod_cycles_model_f = hsmmfit(x = newdata, model = reprod_cycles_model, lock.d = TRUE, lock.transition = TRUE, maxit = 1, graphical = FALSE, debug = TRUE)
toc()


predict_sim_viterbi = predict(object = reprod_cycles_model_f, newdata = newdata, method = "viterbi")

predict_sim_smoothed = predict(object = reprod_cycles_model_f, newdata = newdata, method = "smoothed")

predicted_states  = hsmm$states$abbr[predict_sim_viterbi$s]
table(predicted_states)

obs$day = 1:nrow(obs)
obs$predicted_states = predicted_states

obs_long = melt(as.data.frame(obs), id.vars = c("date","day","predicted_states"))

ggplot(obs_long, aes(x = day, y = value))+
  geom_line()+
  geom_point(aes(col = predicted_states), size = 0.2)+
  facet_grid(variable ~ ., scale = "free")

# ggplot(obs_long, aes(x = day, y = value))+
#   coord_cartesian(xlim = c(121,225))+
#   geom_line()+
#   geom_point(aes(col = predicted_states), size = 0.2)+
#   facet_grid(variable ~ ., scale = "free")


probs = as.data.frame(predict_sim_smoothed$p)
colnames(probs) = hsmm$states$abbr
probs$day = 1:nrow(probs)
probs_l = melt(probs, id.vars = "day")
colnames(probs_l) = c("day","state","p")

ggplot(probs_l, aes(x = day, y= p, col = state))+
  geom_line()+
  scale_color_manual(values = hsmm$states$colors)

```


```{r checking d (sojourn density)}

sojourn_d = as.data.frame(reprod_cycles_model_f$model$d)
colnames(sojourn_d) = hsmm$states$abbr
sojourn_d$day = 1:nrow(sojourn_d)

sojourn_d_l = melt(sojourn_d, id.vars = "day")
colnames(sojourn_d_l) = c("day","state","d")

ggplot(sojourn_d_l, aes(x = day, y = d, col = state))+
  coord_cartesian(xlim = c(-1,400))+
  geom_line()+
  scale_color_manual(values = hsmm$states$colors)+
  facet_grid(state ~ ., scale = "free")

ggplot(sojourn_d_l, aes(x = day, y = d, col = state))+
  coord_cartesian(xlim = c(-1,40))+
  geom_line()+
  scale_color_manual(values = hsmm$states$colors)+
  facet_grid(state ~ ., scale = "free")


# sojourn_D = as.data.frame(reprod_cycles_model_f$model$D)
# colnames(sojourn_D) = hsmm$states$abbr
# sojourn_D$day = 1:nrow(sojourn_D)
# 
# sojourn_D_l = melt(sojourn_D, id.vars = "day")
# colnames(sojourn_D_l) = c("day","state","D")
# 
# ggplot(sojourn_D_l, aes(x = day, y = D, col = state))+
#   coord_cartesian(xlim = c(-1,400))+
#   geom_line()+
#   scale_color_manual(values = hsmm$states$colors)+
#   facet_grid(state ~ ., scale = "free")
#   
# ggplot(sojourn_D_l, aes(x = day, y = D, col = state))+
#   coord_cartesian(xlim = c(-1,40))+
#   geom_line()+
#   scale_color_manual(values = hsmm$states$colors)+
#   facet_grid(state ~ ., scale = "free")


```

```{r checking emission probabilities}


MUs = as.data.frame(matrix(unlist(reprod_cycles_model$parms.emission$mu), nrow = hsmm$n_states, ncol = hsmm$n_obs, byrow = TRUE, dimnames = list(c(hsmm$states$abbr), c(hsmm$obs_names))))
MUs$states = rownames(MUs)
MUs$model = "original"

fitted_MUs = as.data.frame(matrix(unlist(reprod_cycles_model_f$model$parms.emission$mu), nrow = hsmm$n_states, ncol = hsmm$n_obs, byrow = TRUE, dimnames = list(c(hsmm$states$abbr), c(hsmm$obs_names))))
fitted_MUs$states = rownames(fitted_MUs)
fitted_MUs$model = "fitted"

MUs = rbind(MUs, fitted_MUs)
MUs = melt(MUs, id.vars = c("states","model"))
MUs$states = factor(MUs$states, levels = hsmm$states$abbr)
colnames(MUs) = c("states", "model","variable","mu")

SIGMAs = unlist(reprod_cycles_model$parms.emission$sigma) %>%
  matrix(nrow = hsmm$n_states * hsmm$n_obs, ncol =  hsmm$n_obs, byrow = TRUE) %>%
  as.data.frame() %>%
  set_colnames(hsmm$obs_names) %>%
  mutate(states = factor(rep(hsmm$states$abbr,each = hsmm$n_obs), levels = hsmm$states$abbr)) %>%
  group_by(states) %>% 
  summarize_each(funs(max)) %>% 
  as.data.frame()

SIGMAs$model = "original"

fitted_SIGMAs = unlist(reprod_cycles_model_f$model$parms.emission$sigma) %>%
  matrix(nrow = hsmm$n_states * hsmm$n_obs, ncol =  hsmm$n_obs, byrow = TRUE) %>%
  as.data.frame() %>%
  set_colnames(hsmm$obs_names) %>%
  mutate(states = factor(rep(hsmm$states$abbr,each = hsmm$n_obs), levels = hsmm$states$abbr)) %>%
  group_by(states) %>% 
  summarize_each(funs(max)) %>% 
  as.data.frame()

fitted_SIGMAs$model = "fitted"


SIGMAs = rbind(SIGMAs, fitted_SIGMAs)
SIGMAs = melt(SIGMAs, id.vars = c("states","model"))
colnames(SIGMAs) = c("states", "model","variable","sigma")

emissions = left_join(MUs, SIGMAs, by = c("states","model","variable"))

ggplot(emissions, aes(x = interaction(model,states), y =  mu, col = states, shape = model))+
  geom_point()+
  geom_segment(aes(xend = interaction(model,states), y = mu-sigma, yend = mu+sigma))+
  facet_wrap(variable ~ ., scale = "free")+
  scale_color_manual(values = hsmm$states$colors)
#scale_size_discrete(range = c(1,2))


```







```{r}



round(100 * reprod_cycles_model_f$model$transition)
round(100 * reprod_cycles_model$transition)



```






```{r HMM on all cycles}

input_folder = paste0(IO$output_data,"Days_long/")
days_files = list.files(input_folder)

for(file in days_files){
  days = read_feather(paste0(input_folder,file))
  user_ids = unique(days$user_id)
  
  for(user in user_ids){
    j = which(days$user_id == user)
    d = days[j,]
    
    obs = extract_obs(d = d, obs_names = hsmm$obs_names) # create a wide matrix with data for every single day from first day of the first cycle to last day of tracking.
    newdata = list(N  = nrow(obs), x = as.matrix(obs[,-1]))
    
    predict_sim_viterbi = predict(object = reprod_cycles_model_f, newdata = newdata, method = "viterbi")
    
    predict_sim_smoothed = predict(object = reprod_cycles_model_f, newdata = newdata, method = "smoothed")
    
    predicted_states  = hsmm$states$abbr[predict_sim_smoothed$s]
    table(predicted_states)
    
    obs$day = 1:nrow(obs)
    obs$predicted_states = predicted_states
    
    obs_long = melt(obs, id.vars = c("date","day","predicted_states"))
    ggplot(obs_long, aes(x = day, y = value))+
      geom_line()+
      geom_point(aes(col = predicted_states))+
      facet_grid(variable ~ ., scale = "free")
    
    
  }
  
  
  cycle_ids = unique(days$cycle_id)
  
  
  
  
}



```










