---
title: "HsMm model"
author: "Laura Symul"
date: "8/18/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = FALSE)
```


```{r hsmm model setup, include = FALSE, eval = TRUE, cache = FALSE}
source("Scripts/00_setup.R")
```

### Model specifications

#### States

```{r model states}

hsmm = list()

# States

hsmm$states = data.frame(
  names = c("Menses","Early Foll","high E","Ovu - 1","Ovu","Ovu + 2","Luteal","Pregnancy","Pregnancy Loss","Loss day","Pregnancy with birth","Birth","Post-partum","Breast-Feeding","Anovulatory cycle","STOP"),
  abbr = c("M","lE","hE","preO","O","postO","Lut","P","PL","L","PB","B","PP","BF","Ano","stop"),
  colors = c("red3","lightblue1","skyblue1","blue","black","gold3","gold1",
             "deeppink", #pregnancy day
             "pink3", "pink4", #pregnancy with loss
             "plum1","plum2","plum3","plum4", # pregnancy with birth + PP + BF
             "gray","red"),
  stringsAsFactors = FALSE
)
hsmm$states$number = 1:nrow(hsmm$states)
hsmm$states$l = matrix(c(0.25,0.9, #M
                         0.5,2, #lE
                         1.3,1.75, #hE
                         1.75,1, #preO
                         2,0, #O
                         1.75,-1, #postO  
                         1,-2, #lut
                         -0.5, -2, #P
                         -1, -0.25, #PL
                         -1,0.5, #L
                         -1.75, -1.25, #PB
                         -2, 0, #B
                         -1.25, 1.25, #PP
                         -1.5, 2, #BF
                         1,1, #Ano
                         0,0
),
byrow = TRUE,
ncol = 2
)
hsmm$n_states = nrow(hsmm$states)


```

#### Initial Probabilities

```{r init}
# Initial Probabilities
hsmm$init = c(1,rep(0,hsmm$n_states-1))
```

#### Transition Probabilities

```{r transitions}

# Transition Probabilities
hsmm$trans = matrix(rep(0, hsmm$n_states*hsmm$n_states), nrow = hsmm$n_states, dimnames = list(hsmm$states$abbr,hsmm$states$abbr)) 

hsmm$trans[which(hsmm$states$abbr == "M"),which(hsmm$states$abbr == "lE")] = 0.9
hsmm$trans[which(hsmm$states$abbr == "M"),which(hsmm$states$abbr == "stop")] = 0.1

hsmm$trans[which(hsmm$states$abbr == "lE"),which(hsmm$states$abbr == "hE")] = 0.8
hsmm$trans[which(hsmm$states$abbr == "lE"),which(hsmm$states$abbr == "Ano")] = 0.1
hsmm$trans[which(hsmm$states$abbr == "lE"),which(hsmm$states$abbr == "stop")] = 0.1

hsmm$trans[which(hsmm$states$abbr == "hE"),which(hsmm$states$abbr == "lE")] = 0.2
hsmm$trans[which(hsmm$states$abbr == "hE"),which(hsmm$states$abbr == "preO")] = 0.7
hsmm$trans[which(hsmm$states$abbr == "hE"),which(hsmm$states$abbr == "stop")] = 0.1

hsmm$trans[which(hsmm$states$abbr == "preO"),which(hsmm$states$abbr == "O")] = 0.9
hsmm$trans[which(hsmm$states$abbr == "preO"),which(hsmm$states$abbr == "stop")] = 0.1

hsmm$trans[which(hsmm$states$abbr == "O"),which(hsmm$states$abbr == "postO")] = 0.9
hsmm$trans[which(hsmm$states$abbr == "O"),which(hsmm$states$abbr == "stop")] = 0.1

hsmm$trans[which(hsmm$states$abbr == "postO"),which(hsmm$states$abbr == "Lut")] = 0.9
hsmm$trans[which(hsmm$states$abbr == "postO"),which(hsmm$states$abbr == "stop")] = 0.1

hsmm$trans[which(hsmm$states$abbr == "Lut"),which(hsmm$states$abbr == "M")] = 0.7
hsmm$trans[which(hsmm$states$abbr == "Lut"),which(hsmm$states$abbr == "P")] = 0.2
hsmm$trans[which(hsmm$states$abbr == "Lut"),which(hsmm$states$abbr == "stop")] = 0.1

hsmm$trans[which(hsmm$states$abbr == "P"),which(hsmm$states$abbr == "PL")] = 0.6
hsmm$trans[which(hsmm$states$abbr == "P"),which(hsmm$states$abbr == "PB")] = 0.3
hsmm$trans[which(hsmm$states$abbr == "P"),which(hsmm$states$abbr == "stop")] = 0.1

hsmm$trans[which(hsmm$states$abbr == "PL"),which(hsmm$states$abbr == "L")] = 0.9
hsmm$trans[which(hsmm$states$abbr == "PL"),which(hsmm$states$abbr == "stop")] = 0.1

hsmm$trans[which(hsmm$states$abbr == "L"),which(hsmm$states$abbr == "lE")] = 0.9
hsmm$trans[which(hsmm$states$abbr == "L"),which(hsmm$states$abbr == "stop")] = 0.1

hsmm$trans[which(hsmm$states$abbr == "PB"),which(hsmm$states$abbr == "B")] = 0.9
hsmm$trans[which(hsmm$states$abbr == "PB"),which(hsmm$states$abbr == "stop")] = 0.1

hsmm$trans[which(hsmm$states$abbr == "B"),which(hsmm$states$abbr == "PP")] = 0.4
hsmm$trans[which(hsmm$states$abbr == "B"),which(hsmm$states$abbr == "BF")] = 0.5
hsmm$trans[which(hsmm$states$abbr == "B"),which(hsmm$states$abbr == "stop")] = 0.1

hsmm$trans[which(hsmm$states$abbr == "PP"),which(hsmm$states$abbr == "lE")] = 0.9
hsmm$trans[which(hsmm$states$abbr == "PP"),which(hsmm$states$abbr == "stop")] = 0.1

hsmm$trans[which(hsmm$states$abbr == "BF"),which(hsmm$states$abbr == "lE")] = 0.9
hsmm$trans[which(hsmm$states$abbr == "BF"),which(hsmm$states$abbr == "stop")] = 0.1

hsmm$trans[which(hsmm$states$abbr == "Ano"),which(hsmm$states$abbr == "M")] = 0.9
hsmm$trans[which(hsmm$states$abbr == "Ano"),which(hsmm$states$abbr == "stop")] = 0.1

exit_pause = c(1,rep(0.01, hsmm$n_states - 2),0)
hsmm$trans[which(hsmm$states$abbr == "stop"),] = exit_pause/sum(exit_pause)

hsmm$trans_no_names = hsmm$trans
colnames(hsmm$trans_no_names) = NULL
rownames(hsmm$trans_no_names) = NULL
```


```{r transition viz, fig.height=6, fig.width=6}

g = graph_from_adjacency_matrix(hsmm$trans, weighted = TRUE, mode = "directed")
E(g)$width <- 1+E(g)$weight*5
plot(g,# edge.arrow.size=0.75, 
     vertex.size=30, vertex.frame.color="white", 
     vertex.label.color="white", vertex.label.family  = "sans",
     vertex.color = hsmm$states$colors[match(V(g)$name,  hsmm$states$abbr)],
     layout = hsmm$states$l
)

g = graph_from_adjacency_matrix(hsmm$trans[-hsmm$n_states,-hsmm$n_states], weighted = TRUE, mode = "directed")
E(g)$width <- 1+E(g)$weight*5
plot(g,# edge.arrow.size=0.75, 
     vertex.size=30, vertex.frame.color="white", 
     vertex.label.color="white", vertex.label.family  = "sans",
     vertex.color = hsmm$states$colors[match(V(g)$name,  hsmm$states$abbr)],
     layout = hsmm$states$l[-hsmm$n_states,]
)

```

#### Emission probabilities

We have 6 input variables:
1. normalized temperature
2. mucus score
3. [binary] first day of cycle
4. pregnancy tests [-1 ; 0; 1]
5. [binary] any log
6. the gap length between two logs

We need to define probabilities for each of these variables in each state.
We will, for now, use normal distributions and assume co-variances are 0.

For the temperature, the mucus score, and gap length, we will use the actual data to estimate their emission probabilities

```{r hsmm loading a sample of the data to evaluate the emission probabilities}

s_days_file = paste0(IO$tmp_data,"s_days.feather")
if(!file.exists(s_days_file) | FALSE ){
  
  cycles = read_feather(path = paste0(IO$output_data,"cycles.feather"))
  users = read_feather(path = paste0(IO$output_data,"users.feather"))
  
  # we will use data from a subset of cycles of length 23-45
  j = which((cycles$cycle_length %in% 23:45) & (users$batch[match(cycles$user_id, users$user_id)] %in% 1:10))
  cycle_ids  = cycles$cycle_id[j]
  
  input_folder = paste0(IO$output_data,"Days/")
  days_files = paste0("days_",1:10,".feather")
  
  s_days = foreach(file = days_files, .combine = rbind) %do% {
    cat(file, "\n")
    days = read_feather(paste0(input_folder,file))
    j = which((days$cycle_id %in% cycle_ids) & 
                ((days$cycleday <= 28) | (days$cycleday_from_end >= -28)) &
                (!(is.na(days$temp) & is.na(days$mucus)) & 
                   (abs(days$temp) <= 15))
    )
    #cat(range(days$temp, na.rm = TRUE), "\n")
    days = days[j,]
    return(days)
  }
  
  write_feather(s_days, path = s_days_file)
}else{
  s_days = read_feather(path = s_days_file) 
}
```



```{r hsmm emission what is observed in presumed ovulatory cycles}

forward_backward_file =  paste0(IO$tmp_data, "forward_and_backward_agg.Rdata")
if(!file.exists(forward_backward_file) | FALSE){
  
  forward_agg =  ddply(s_days[which(s_days$cycleday <= 28),],
                       .(cycleday),
                       .fun = summarize,
                       cycleday_type = "cycleday",
                       bleeding_mean = mean(bleeding, na.rm = TRUE),
                       bleeding_sd = sd(bleeding, na.rm = TRUE),
                       temp_mean = mean(temp, na.rm = TRUE),
                       temp_sd = sd(temp, na.rm = TRUE),
                       mucus_mean = mean(mucus, na.rm = TRUE),
                       mucus_sd = sd(mucus, na.rm = TRUE),
                       LH_mean = mean(LH, na.rm = TRUE),
                       LH_sd = sd(LH, na.rm = TRUE),
                       preg_test_mean = mean(preg_test_score, na.rm = TRUE),
                       preg_test_sd = sd(preg_test_score, na.rm = TRUE),
                       gap_mean = mean(gap, na.rm = TRUE),
                       gap_sd = sd(gap, na.rm = TRUE),
                       first_day_mean = mean(first_day, na.rm = TRUE),
                       first_day_sd = sd(first_day, na.rm = TRUE)
  )
  
  backward_agg =  ddply(s_days[which(s_days$cycleday_from_end >= -28),],
                        .(cycleday_from_end),
                        .fun = summarize,
                        cycleday_type = "cycleday_from_end",
                        bleeding_mean = mean(bleeding, na.rm = TRUE),
                        bleeding_sd = sd(bleeding, na.rm = TRUE),
                        temp_mean = mean(temp, na.rm = TRUE),
                        temp_sd = sd(temp, na.rm = TRUE),
                        mucus_mean = mean(mucus, na.rm = TRUE),
                        mucus_sd = sd(mucus, na.rm = TRUE),
                        LH_mean = mean(LH, na.rm = TRUE),
                        LH_sd = sd(LH, na.rm = TRUE),
                        preg_test_mean = mean(preg_test_score, na.rm = TRUE),
                        preg_test_sd = sd(preg_test_score, na.rm = TRUE),
                        gap_mean = mean(gap, na.rm = TRUE),
                        gap_sd = sd(gap, na.rm = TRUE),
                        first_day_mean = mean(first_day, na.rm = TRUE),
                        first_day_sd = sd(first_day, na.rm = TRUE)
  )
  colnames(backward_agg)
  
  save(forward_agg, backward_agg, file =forward_backward_file)
  
}else{
  load(forward_backward_file, verbose = TRUE)
}


```



```{r forward and backward agg viz}

g = ggplot(backward_agg, aes(x = cycleday_from_end))+
  geom_line(aes(y = bleeding_mean), col = "red")+
  geom_ribbon(aes(ymin = bleeding_mean - bleeding_sd/2, ymax = bleeding_mean + bleeding_sd/2), alpha = 0.2, fill = "red")+
  geom_line(aes(y = mucus_mean))+
  geom_ribbon(aes(ymin = mucus_mean - mucus_sd/2, ymax = mucus_mean + mucus_sd/2), alpha = 0.2)+
  geom_line(aes(y = temp_mean), col = "purple")+
  geom_ribbon(aes(ymin = temp_mean - temp_sd/2, ymax = temp_mean + temp_sd/2), alpha = 0.2, fill = "purple")+
  geom_line(aes(y = LH_mean), col = "blue")+
  geom_ribbon(aes(ymin = LH_mean - LH_sd/2, ymax = LH_mean + LH_sd/2), alpha = 0.2, fill = "blue")+
  geom_line(aes(y = preg_test_mean), col = "green3")+
  geom_ribbon(aes(ymin = preg_test_mean - preg_test_sd/2, ymax = preg_test_mean + preg_test_sd/2), alpha = 0.2, fill = "green3")
g

g = ggplot(forward_agg, aes(x = cycleday))+
  geom_line(aes(y = bleeding_mean), col = "red")+
  geom_ribbon(aes(ymin = bleeding_mean - bleeding_sd/2, ymax = bleeding_mean + bleeding_sd/2), alpha = 0.2, fill = "red")+
  geom_line(aes(y = mucus_mean))+
  geom_line(aes(y = temp_mean), col = "purple")+
  geom_ribbon(aes(ymin = mucus_mean - mucus_sd/2, ymax = mucus_mean + mucus_sd/2), alpha = 0.2)+
  geom_ribbon(aes(ymin = temp_mean - temp_sd/2, ymax = temp_mean + temp_sd/2), alpha = 0.2, fill = "purple")+
  geom_line(aes(y = LH_mean), col = "blue")+
  geom_ribbon(aes(ymin = LH_mean - LH_sd/2, ymax = LH_mean + LH_sd/2), alpha = 0.2, fill = "blue")+
  geom_line(aes(y = preg_test_mean), col = "green3")+
  geom_ribbon(aes(ymin = preg_test_mean - preg_test_sd/2, ymax = preg_test_mean + preg_test_sd/2), alpha = 0.2, fill = "green3")
g


g = ggplot(backward_agg, aes(x = cycleday_from_end))+
  geom_line(aes(y = LH_mean), col = "blue")+
  geom_ribbon(aes(ymin = LH_mean - LH_sd/2, ymax = LH_mean + LH_sd/2), alpha = 0.2, fill = "blue")+
  geom_line(aes(y = preg_test_mean), col = "green3")+
  geom_ribbon(aes(ymin = preg_test_mean - preg_test_sd/2, ymax = preg_test_mean + preg_test_sd/2), alpha = 0.2, fill = "green3")
g


g = ggplot(forward_agg, aes(x = cycleday))+
  geom_line(aes(y = LH_mean), col = "blue")+
  geom_ribbon(aes(ymin = LH_mean - LH_sd/2, ymax = LH_mean + LH_sd/2), alpha = 0.2, fill = "blue")+
  geom_line(aes(y = preg_test_mean), col = "green3")+
  geom_ribbon(aes(ymin = preg_test_mean - preg_test_sd/2, ymax = preg_test_mean + preg_test_sd/2), alpha = 0.2, fill = "green3")
g



g = ggplot(backward_agg, aes(x = cycleday_from_end))+
  geom_line(aes(y = gap_mean), col = "purple")+
  geom_ribbon(aes(ymin = gap_mean - gap_sd/2, ymax = gap_mean + gap_sd/2), alpha = 0.2, fill = "purple")
g

g = ggplot(forward_agg, aes(x = cycleday))+
  geom_line(aes(y = gap_mean), col = "purple")+
  geom_ribbon(aes(ymin = gap_mean - gap_sd/2, ymax = gap_mean + gap_sd/2), alpha = 0.2, fill = "purple")
g



g = ggplot(backward_agg, aes(x = cycleday_from_end))+
  geom_line(aes(y = first_day_mean), col = "black")+
  geom_ribbon(aes(ymin = first_day_mean - first_day_sd/2, ymax = first_day_mean + first_day_sd/2), alpha = 0.2, fill = "black")
g


g = ggplot(forward_agg, aes(x = cycleday))+
  geom_line(aes(y = first_day_mean), col = "black")+
  geom_ribbon(aes(ymin = first_day_mean - first_day_sd/2, ymax = first_day_mean + first_day_sd/2), alpha = 0.2, fill = "black")
g


# geom_line(aes(y = anylog_mean), col = "blue")+
# geom_ribbon(aes(ymin = anylog_mean - anylog_sd/2, ymax = anylog_mean + anylog_sd/2), alpha = 0.2, fill = "blue")


```




```{r hsmm emissions }

bleeding_mean = c()
bleeding_sigma = c()
temp_mean = c()
temp_sigma = c()
mucus_mean = c()
mucus_sigma = c()
LH_mean = c()
LH_sigma = c()
preg_test_mean = c()
preg_test_sigma = c()
anylog_mean = c(1,rep(0.5,6),0.75,0.25,0.5,0.25,0.5,0.3,0.3,0.75,0)
anylog_sigma = rep(1,16)
#gap_mean = c(rep(1.25,length(c("M","lE","hE","preO","O","postO","lut"))),rep(50,length(c("P","PL","L","BP","B","PP","BF"))),1.25,150)
gap_mean = c(rep(0,length(c("M","lE","hE","preO","O","postO","lut","P"))),rep(0.5,length(c("PL","L","BP","B","PP","BF"))),0,1)
gap_sigma = c(rep(0.2,length(c("M","lE","hE","preO","O","postO","lut","P"))),rep(0.5,length(c("PL","L","BP","B","PP","BF"))),0.2,0.2)
first_day_mean = rep(0, hsmm$n_states)
first_day_mean[match(c("M","L","B"),hsmm$states$abbr)] = c(0.75,0.5,0.3)
first_day_sigma = rep(0.5, hsmm$n_states)
first_day_sigma[match(c("M","L","B"),hsmm$states$abbr)] = c(1,1,1)


# Menses
days = 1:5
bleeding_mean = c(bleeding_mean, mean(forward_agg$bleeding_mean[forward_agg$cycleday %in% days]))
bleeding_sigma = c(bleeding_sigma, max(forward_agg$bleeding_sd[forward_agg$cycleday %in% days]))
temp_mean = c(temp_mean, mean(forward_agg$temp_mean[forward_agg$cycleday %in% days]))
temp_sigma = c(temp_sigma, max(forward_agg$temp_sd[forward_agg$cycleday %in% days]))
mucus_mean = c(mucus_mean, mean(forward_agg$mucus_mean[forward_agg$cycleday %in% days]))
mucus_sigma = c(mucus_sigma, max(forward_agg$mucus_sd[forward_agg$cycleday %in% days]))
LH_mean = c(LH_mean, mean(forward_agg$LH_mean[forward_agg$cycleday %in% days]))
LH_sigma = c(LH_sigma, max(forward_agg$LH_sd[forward_agg$cycleday %in% days]))
preg_test_mean = c(preg_test_mean, -1)
preg_test_sigma = c(preg_test_sigma, max(forward_agg$preg_test_sd[forward_agg$cycleday %in% days]))


# lE
days = 6:11
bleeding_mean = c(bleeding_mean, mean(forward_agg$bleeding_mean[forward_agg$cycleday %in% days]))
bleeding_sigma = c(bleeding_sigma, max(forward_agg$bleeding_sd[forward_agg$cycleday %in% days]))
temp_mean = c(temp_mean, mean(forward_agg$temp_mean[forward_agg$cycleday %in% days]))
temp_sigma = c(temp_sigma, max(forward_agg$temp_sd[forward_agg$cycleday %in% days]))
mucus_mean = c(mucus_mean, mean(forward_agg$mucus_mean[forward_agg$cycleday %in% days]))
mucus_sigma = c(mucus_sigma, max(forward_agg$mucus_sd[forward_agg$cycleday %in% days]))
LH_mean = c(LH_mean, mean(forward_agg$LH_mean[forward_agg$cycleday %in% days]))
LH_sigma = c(LH_sigma, max(forward_agg$LH_sd[forward_agg$cycleday %in% days]))
preg_test_mean = c(preg_test_mean, -1)
preg_test_sigma = c(preg_test_sigma, max(forward_agg$preg_test_sd[forward_agg$cycleday %in% days]))


# hE
days = -18:-15
bleeding_mean = c(bleeding_mean, mean(backward_agg$bleeding_mean[backward_agg$cycleday_from_end %in% days]))
bleeding_sigma = c(bleeding_sigma, max(backward_agg$bleeding_sd[backward_agg$cycleday_from_end %in% days]))
temp_mean = c(temp_mean, mean(backward_agg$temp_mean[backward_agg$cycleday_from_end %in% days]))
temp_sigma = c(temp_sigma, max(backward_agg$temp_sd[backward_agg$cycleday_from_end %in% days]))
mucus_mean = c(mucus_mean, mean(backward_agg$mucus_mean[backward_agg$cycleday_from_end %in% days]))
mucus_sigma = c(mucus_sigma, max(backward_agg$mucus_sd[backward_agg$cycleday_from_end %in% days]))
LH_mean = c(LH_mean, mean(backward_agg$LH_mean[backward_agg$cycleday_from_end %in% days]))
LH_sigma = c(LH_sigma, max(backward_agg$LH_sd[backward_agg$cycleday_from_end %in% days]))
preg_test_mean = c(preg_test_mean, -1)
preg_test_sigma = c(preg_test_sigma, max(backward_agg$preg_test_sd[backward_agg$cycleday_from_end %in% days]))


# preO
days = -14
bleeding_mean = c(bleeding_mean, mean(backward_agg$bleeding_mean[backward_agg$cycleday_from_end %in% days]))
bleeding_sigma = c(bleeding_sigma, max(backward_agg$bleeding_sd[backward_agg$cycleday_from_end %in% days]))
temp_mean = c(temp_mean, mean(backward_agg$temp_mean[backward_agg$cycleday_from_end %in% days]))
temp_sigma = c(temp_sigma, max(backward_agg$temp_sd[backward_agg$cycleday_from_end %in% days]))
mucus_mean = c(mucus_mean, mean(backward_agg$mucus_mean[backward_agg$cycleday_from_end %in% days]))
mucus_sigma = c(mucus_sigma, max(backward_agg$mucus_sd[backward_agg$cycleday_from_end %in% days]))
LH_mean = c(LH_mean, 1)
LH_sigma = c(LH_sigma, max(backward_agg$LH_sd[backward_agg$cycleday_from_end %in% days]))
preg_test_mean = c(preg_test_mean, -1)
preg_test_sigma = c(preg_test_sigma, max(backward_agg$preg_test_sd[backward_agg$cycleday_from_end %in% days]))


# O
days = -13
bleeding_mean = c(bleeding_mean, mean(backward_agg$bleeding_mean[backward_agg$cycleday_from_end %in% days]))
bleeding_sigma = c(bleeding_sigma, max(backward_agg$bleeding_sd[backward_agg$cycleday_from_end %in% days]))
temp_mean = c(temp_mean, mean(backward_agg$temp_mean[backward_agg$cycleday_from_end %in% days]))
temp_sigma = c(temp_sigma, max(backward_agg$temp_sd[backward_agg$cycleday_from_end %in% days]))
mucus_mean = c(mucus_mean, mean(backward_agg$mucus_mean[backward_agg$cycleday_from_end %in% days]))
mucus_sigma = c(mucus_sigma, max(backward_agg$mucus_sd[backward_agg$cycleday_from_end %in% days]))
LH_mean = c(LH_mean, 0.8)
LH_sigma = c(LH_sigma, max(backward_agg$LH_sd[backward_agg$cycleday_from_end %in% days]))
preg_test_mean = c(preg_test_mean, mean(backward_agg$preg_test_mean[backward_agg$cycleday_from_end %in% days]))
preg_test_sigma = c(preg_test_sigma, max(backward_agg$preg_test_sd[backward_agg$cycleday_from_end %in% days]))


# postO
days = -12:-11
bleeding_mean = c(bleeding_mean, mean(backward_agg$bleeding_mean[backward_agg$cycleday_from_end %in% days]))
bleeding_sigma = c(bleeding_sigma, max(backward_agg$bleeding_sd[backward_agg$cycleday_from_end %in% days]))
temp_mean = c(temp_mean, mean(backward_agg$temp_mean[backward_agg$cycleday_from_end %in% days]))
temp_sigma = c(temp_sigma, max(backward_agg$temp_sd[backward_agg$cycleday_from_end %in% days]))
mucus_mean = c(mucus_mean, mean(backward_agg$mucus_mean[backward_agg$cycleday_from_end %in% days]))
mucus_sigma = c(mucus_sigma, max(backward_agg$mucus_sd[backward_agg$cycleday_from_end %in% days]))
LH_mean = c(LH_mean, 0)
LH_sigma = c(LH_sigma, max(backward_agg$LH_sd[backward_agg$cycleday_from_end %in% days]))
preg_test_mean = c(preg_test_mean, mean(backward_agg$preg_test_mean[backward_agg$cycleday_from_end %in% days]))
preg_test_sigma = c(preg_test_sigma, max(backward_agg$preg_test_sd[backward_agg$cycleday_from_end %in% days]))


# Lut
days = -10:-1
bleeding_mean = c(bleeding_mean, mean(backward_agg$bleeding_mean[backward_agg$cycleday_from_end %in% days]))
bleeding_sigma = c(bleeding_sigma, max(backward_agg$bleeding_sd[backward_agg$cycleday_from_end %in% days]))
temp_mean = c(temp_mean, mean(backward_agg$temp_mean[backward_agg$cycleday_from_end %in% days]))
temp_sigma = c(temp_sigma, max(backward_agg$temp_sd[backward_agg$cycleday_from_end %in% days]))
mucus_mean = c(mucus_mean, mean(backward_agg$mucus_mean[backward_agg$cycleday_from_end %in% days]))
mucus_sigma = c(mucus_sigma, max(backward_agg$mucus_sd[backward_agg$cycleday_from_end %in% days]))
LH_mean = c(LH_mean, 0)
LH_sigma = c(LH_sigma, max(backward_agg$LH_sd[backward_agg$cycleday_from_end %in% days]))
preg_test_mean = c(preg_test_mean, mean(backward_agg$preg_test_mean[backward_agg$cycleday_from_end %in% days]))
preg_test_sigma = c(preg_test_sigma, max(backward_agg$preg_test_sd[backward_agg$cycleday_from_end %in% days]))
days = -10:-3


# P
days = -6:-5
bleeding_mean = c(bleeding_mean, mean(backward_agg$bleeding_mean[backward_agg$cycleday_from_end %in% days]))
bleeding_sigma = c(bleeding_sigma, max(backward_agg$bleeding_sd[backward_agg$cycleday_from_end %in% days]))
temp_mean = c(temp_mean, mean(backward_agg$temp_mean[backward_agg$cycleday_from_end %in% days]))
temp_sigma = c(temp_sigma, max(backward_agg$temp_sd[backward_agg$cycleday_from_end %in% days]))
mucus_mean = c(mucus_mean, mean(backward_agg$mucus_mean[backward_agg$cycleday_from_end %in% days]))
mucus_sigma = c(mucus_sigma, max(backward_agg$mucus_sd[backward_agg$cycleday_from_end %in% days]))
LH_mean = c(LH_mean, 0)
LH_sigma = c(LH_sigma, max(backward_agg$LH_sd[backward_agg$cycleday_from_end %in% days]))
preg_test_mean = c(preg_test_mean, 1)
preg_test_sigma = c(preg_test_sigma, max(backward_agg$preg_test_sd[backward_agg$cycleday_from_end %in% days]))
days = -2:-1


# PL
days = -6:-5
bleeding_mean = c(bleeding_mean, mean(backward_agg$bleeding_mean[backward_agg$cycleday_from_end %in% days]))
bleeding_sigma = c(bleeding_sigma, 1)
temp_mean = c(temp_mean, mean(backward_agg$temp_mean[backward_agg$cycleday_from_end %in% days]))
temp_sigma = c(temp_sigma, max(backward_agg$temp_sd[backward_agg$cycleday_from_end %in% days]))
mucus_mean = c(mucus_mean, mean(backward_agg$mucus_mean[backward_agg$cycleday_from_end %in% days]))
mucus_sigma = c(mucus_sigma, max(backward_agg$mucus_sd[backward_agg$cycleday_from_end %in% days]))
LH_mean = c(LH_mean, 0)
LH_sigma = c(LH_sigma, max(backward_agg$LH_sd[backward_agg$cycleday_from_end %in% days]))
preg_test_mean = c(preg_test_mean, 0)
preg_test_sigma = c(preg_test_sigma, 1)
days = -2:-1


# L
days = 1:5
bleeding_mean = c(bleeding_mean, mean(forward_agg$bleeding_mean[forward_agg$cycleday %in% days]))
bleeding_sigma = c(bleeding_sigma, 1)
days = -2:-1
temp_mean = c(temp_mean, mean(backward_agg$temp_mean[backward_agg$cycleday_from_end %in% days]))
temp_sigma = c(temp_sigma, max(backward_agg$temp_sd[backward_agg$cycleday_from_end %in% days]))
mucus_mean = c(mucus_mean, mean(backward_agg$mucus_mean[backward_agg$cycleday_from_end %in% days]))
mucus_sigma = c(mucus_sigma, max(backward_agg$mucus_sd[backward_agg$cycleday_from_end %in% days]))
LH_mean = c(LH_mean, 0)
LH_sigma = c(LH_sigma, max(backward_agg$LH_sd[backward_agg$cycleday_from_end %in% days]))
preg_test_mean = c(preg_test_mean, -1)
preg_test_sigma = c(preg_test_sigma, max(backward_agg$preg_test_sd[backward_agg$cycleday_from_end %in% days]))
days = -2:-1


# PB
days =  -6:-5
bleeding_mean = c(bleeding_mean, mean(backward_agg$bleeding_mean[backward_agg$cycleday_from_end %in% days]))
bleeding_sigma = c(bleeding_sigma, 1)
temp_mean = c(temp_mean, mean(backward_agg$temp_mean[backward_agg$cycleday_from_end %in% days]))
temp_sigma = c(temp_sigma, max(backward_agg$temp_sd[backward_agg$cycleday_from_end %in% days]))
mucus_mean = c(mucus_mean, mean(backward_agg$mucus_mean[backward_agg$cycleday_from_end %in% days]))
mucus_sigma = c(mucus_sigma, max(backward_agg$mucus_sd[backward_agg$cycleday_from_end %in% days]))
LH_mean = c(LH_mean, 0)
LH_sigma = c(LH_sigma, max(backward_agg$LH_sd[backward_agg$cycleday_from_end %in% days]))
preg_test_mean = c(preg_test_mean, 1)
preg_test_sigma = c(preg_test_sigma, max(backward_agg$preg_test_sd[backward_agg$cycleday_from_end %in% days]))


# B
days = 1:5
bleeding_mean = c(bleeding_mean, mean(forward_agg$bleeding_mean[forward_agg$cycleday %in% days]))
bleeding_sigma = c(bleeding_sigma, 1)
days =  -28:-1
temp_mean = c(temp_mean, mean(backward_agg$temp_mean[backward_agg$cycleday_from_end %in% days]))
temp_sigma = c(temp_sigma, max(backward_agg$temp_sd[backward_agg$cycleday_from_end %in% days]))
mucus_mean = c(mucus_mean, mean(backward_agg$mucus_mean[backward_agg$cycleday_from_end %in% days]))
mucus_sigma = c(mucus_sigma, max(backward_agg$mucus_sd[backward_agg$cycleday_from_end %in% days]))
LH_mean = c(LH_mean, 0)
LH_sigma = c(LH_sigma, max(backward_agg$LH_sd[backward_agg$cycleday_from_end %in% days]))
preg_test_mean = c(preg_test_mean, 0)
preg_test_sigma = c(preg_test_sigma, 1)


# PP
days =  days = 6:11
bleeding_mean = c(bleeding_mean, mean(forward_agg$bleeding_mean[forward_agg$cycleday %in% days]))
bleeding_sigma = c(bleeding_sigma, mean(forward_agg$bleeding_sd[forward_agg$cycleday %in% days]))
temp_mean = c(temp_mean, mean(forward_agg$temp_mean[forward_agg$cycleday %in% days]))
temp_sigma = c(temp_sigma, max(forward_agg$temp_sd[forward_agg$cycleday %in% days]))
mucus_mean = c(mucus_mean, mean(forward_agg$mucus_mean[forward_agg$cycleday %in% days]))
mucus_sigma = c(mucus_sigma, max(forward_agg$mucus_sd[forward_agg$cycleday %in% days]))
LH_mean = c(LH_mean, 0)
LH_sigma = c(LH_sigma, max(forward_agg$LH_sd[forward_agg$cycleday %in% days]))
preg_test_mean = c(preg_test_mean, -1)
preg_test_sigma = c(preg_test_sigma, 1)


# BF
days = 6:11
bleeding_mean = c(bleeding_mean, mean(forward_agg$bleeding_mean[forward_agg$cycleday %in% days]))
bleeding_sigma = c(bleeding_sigma, mean(forward_agg$bleeding_sd[forward_agg$cycleday %in% days]))
temp_mean = c(temp_mean, mean(backward_agg$temp_mean[forward_agg$cycleday %in% days]))
temp_sigma = c(temp_sigma, max(backward_agg$temp_sd[forward_agg$cycleday %in% days]))
mucus_mean = c(mucus_mean, mean(forward_agg$mucus_mean[forward_agg$cycleday %in% days]))
mucus_sigma = c(mucus_sigma, max(forward_agg$mucus_sd[forward_agg$cycleday %in% days]))
LH_mean = c(LH_mean, 0 )
LH_sigma = c(LH_sigma, max(forward_agg$LH_sd[forward_agg$cycleday %in% days]))
preg_test_mean = c(preg_test_mean, -1)
preg_test_sigma = c(preg_test_sigma, 1)


# Ano
days = 6:11
bleeding_mean = c(bleeding_mean, mean(forward_agg$bleeding_mean[forward_agg$cycleday %in% days]))
bleeding_sigma = c(bleeding_sigma, mean(forward_agg$bleeding_sd[forward_agg$cycleday %in% days]))
temp_mean = c(temp_mean, mean(backward_agg$temp_mean[forward_agg$cycleday %in% days]))
temp_sigma = c(temp_sigma, max(backward_agg$temp_sd[forward_agg$cycleday %in% days]))
days =  days = 6:15
mucus_mean = c(mucus_mean, mean(forward_agg$mucus_mean[forward_agg$cycleday %in% days]))
mucus_sigma = c(mucus_sigma, max(forward_agg$mucus_sd[forward_agg$cycleday %in% days]))
LH_mean = c(LH_mean, mean(forward_agg$LH_mean[forward_agg$cycleday %in% days]))
LH_sigma = c(LH_sigma, max(forward_agg$LH_sd[forward_agg$cycleday %in% days]))
preg_test_mean = c(preg_test_mean, -1)
preg_test_sigma = c(preg_test_sigma, max(forward_agg$preg_test_sd[forward_agg$cycleday %in% days]))


# stop
days = -28:-1
bleeding_mean = c(bleeding_mean, mean(backward_agg$bleeding_mean[backward_agg$cycleday_from_end %in% days]))
bleeding_sigma = c(bleeding_sigma, mean(backward_agg$bleeding_sd[backward_agg$cycleday_from_end %in% days]))
temp_mean = c(temp_mean, mean(backward_agg$temp_mean[backward_agg$cycleday_from_end %in% days]))
temp_sigma = c(temp_sigma, max(backward_agg$temp_sd[backward_agg$cycleday_from_end %in% days]))
mucus_mean = c(mucus_mean, mean(backward_agg$mucus_mean[backward_agg$cycleday_from_end %in% days]))
mucus_sigma = c(mucus_sigma, max(backward_agg$mucus_sd[backward_agg$cycleday_from_end %in% days]))
LH_mean = c(LH_mean, mean(backward_agg$LH_mean[backward_agg$cycleday_from_end %in% days]))
LH_sigma = c(LH_sigma, max(backward_agg$LH_sd[backward_agg$cycleday_from_end %in% days]))
preg_test_mean = c(preg_test_mean, 0)
preg_test_sigma = c(preg_test_sigma, 1)


```

```{r hsmm adding emissions to hsmm states}

hsmm$states$emis_bleeding_mean = bleeding_mean
hsmm$states$emis_bleeding_sigma = bleeding_sigma
hsmm$states$emis_temp_mean = temp_mean
hsmm$states$emis_temp_sigma = temp_sigma
hsmm$states$emis_mucus_mean = mucus_mean
hsmm$states$emis_mucus_sigma = mucus_sigma
hsmm$states$emis_LH_mean = LH_mean
hsmm$states$emis_LH_sigma = LH_sigma
hsmm$states$emis_preg_test_mean = preg_test_mean
hsmm$states$emis_preg_test_sigma = preg_test_sigma
hsmm$states$emis_anylog_mean = anylog_mean
hsmm$states$emis_anylog_sigma = anylog_sigma
hsmm$states$emis_gap_mean = gap_mean
hsmm$states$emis_gap_sigma = gap_sigma
hsmm$states$emis_first_day_mean = first_day_mean
hsmm$states$emis_first_day_sigma = first_day_sigma
```




```{r hsmm emissions formatting for model spec.}

obs_names = c("bleeding","temp","mucus","LH","preg_test","anylog","gap","first_day")
hsmm$n_obs = 8
j = 1:hsmm$n_obs
hsmm$obs_names = obs_names[j]
colnames_emis_mean = paste0("emis_",hsmm$obs_names,"_mean")
k = match(colnames_emis_mean, colnames(hsmm$states))[j]
colnames_emis_sigma = paste0("emis_",hsmm$obs_names,"_sigma")
l = match(colnames_emis_sigma, colnames(hsmm$states))[j]


hsmm$emission = list(mu = list(
  as.numeric(hsmm$states[1,k]), # M
  as.numeric(hsmm$states[2,k]), # lE
  as.numeric(hsmm$states[3,k]), # hE
  as.numeric(hsmm$states[4,k]), # preO
  as.numeric(hsmm$states[5,k]), # O
  as.numeric(hsmm$states[6,k]), # postO
  as.numeric(hsmm$states[7,k]), # Lut
  as.numeric(hsmm$states[8,k]), # P
  as.numeric(hsmm$states[9,k]), # PL
  as.numeric(hsmm$states[10,k]), # L
  as.numeric(hsmm$states[11,k]), # PB
  as.numeric(hsmm$states[12,k]), # B
  as.numeric(hsmm$states[13,k]), # PP
  as.numeric(hsmm$states[14,k]), # BF
  as.numeric(hsmm$states[15,k]), # Ano
  as.numeric(hsmm$states[16,k]) # stop
),
sigma = list(
  diag(hsmm$states[1,l]), # M
  diag(hsmm$states[2,l]), # lE
  diag(hsmm$states[3,l]), # hE
  diag(hsmm$states[4,l]), # preO
  diag(hsmm$states[5,l]), # O
  diag(hsmm$states[6,l]), # postO
  diag(hsmm$states[7,l]), # Lut
  diag(hsmm$states[8,l]), # P
  diag(hsmm$states[9,l]), # PL
  diag(hsmm$states[10,l]), # L
  diag(hsmm$states[11,l]), # PB
  diag(hsmm$states[12,l]), # B
  diag(hsmm$states[13,l]), # PP
  diag(hsmm$states[14,l]), # BF
  diag(hsmm$states[15,l]), # Ano
  diag(hsmm$states[16,l]) # stop
))


```


#### Sojourn

To estimate the parameters of the gamma distributions, we will use the data from Kindara from the FAM paper


```{r hsmm load Kindara data from FAM paper}

kindara_agg_file = paste0(IO$tmp_data,"FAM_kindara_hmm_states_agg.feather")

if(!file.exists(kindara_agg_file) | FALSE){
  
  load(paste0(IO$FAM_paper_kindara_data,"Cycles/06 CYCLES with reliable ovulation estimation.Rdata"), verbose = TRUE)
  
  days_input_folder = paste0(IO$FAM_paper_kindara_data,"Days/05 post HMM/")
  days_files = list.files(days_input_folder)
  days_feather_output_folder = paste0(IO$FAM_paper_kindara_data,"Days/05 post HMM feather/")
  if(!dir.exists(days_feather_output_folder)){dir.create(days_feather_output_folder, recursive = TRUE)}
  tmp_agg_folder = paste0(IO$tmp_data,"FAM_kindara_states_agg/")
  if(!dir.exists(tmp_agg_folder)){dir.create(tmp_agg_folder, recursive = TRUE)}
  
  
  for(file in days_files){
    cat(file, "\n")
    load(paste0(days_input_folder, file), verbose = TRUE)
    
    days$n_days = 1
    agg = aggregate(n_days ~ cycle_id + states, days, sum)
    
    write_feather(agg, path = paste0(tmp_agg_folder,gsub("Rdata","feather",paste0("agg_",file))))
    
    j = which(colnames(days) == "n_days")
    if(length(j)==1){days = days[,-j]}
    
    feather_file_name = gsub("Rdata","feather",file)
    write_feather(days, path = paste0(days_feather_output_folder,feather_file_name))
  }
  
  agg_files = list.files(tmp_agg_folder)
  agg = foreach(agg_file = agg_files, .combine = rbind) %do% {this_agg = read_feather(path = paste0(tmp_agg_folder,agg_file));return(this_agg)}
  write_feather(agg, path = kindara_agg_file)
  
}else{
  agg = read_feather(path = kindara_agg_file)
}


```


```{r hsmm combining HMM states to states of the hsmm}

FAM_agg_sojourn_file = paste0(IO$tmp_data,"FAM_kindara_hsmm_states_agg.feather")

if(!file.exists(FAM_agg_sojourn_file) | FALSE){
  
  unique(agg$states)
  agg$hsmm_states  = agg$states
  
  # menses
  agg$hsmm_states = gsub("hM","M",agg$hsmm_states)
  agg$hsmm_states = gsub("lM","M",agg$hsmm_states)
  
  # Luteal
  agg$hsmm_states = gsub("Rise","Lut",agg$hsmm_states)
  agg$hsmm_states = gsub("Ep","Lut",agg$hsmm_states)
  agg$hsmm_states = gsub("lP","Lut",agg$hsmm_states)
  agg$hsmm_states = gsub("hP","Lut",agg$hsmm_states)
  
  FAM_agg_sojourn = aggregate(n_days ~ cycle_id + hsmm_states , agg, sum)
  
  cycles_out = FAM_agg_sojourn$cycle_id[which((FAM_agg_sojourn$n_days == 2)&(FAM_agg_sojourn$hsmm_states == "Lut"))]
  j = which(!(FAM_agg_sojourn$cycle_id %in% cycles_out))
  FAM_agg_sojourn = FAM_agg_sojourn[j,]
  
  write_feather(FAM_agg_sojourn, path = FAM_agg_sojourn_file)
}else{
  FAM_agg_sojourn = read_feather(path = FAM_agg_sojourn_file)
}



ggplot(FAM_agg_sojourn[j,], aes(x = n_days, fill = hsmm_states))+
  geom_histogram(position = "identity", binwidth = 1)+
  facet_grid(hsmm_states ~ ., scale = "free")+
  xlim(c(0,50))


ggplot(FAM_agg_sojourn, aes(x = n_days, fill = hsmm_states))+
  geom_histogram(position = "identity", binwidth = 1)+
  facet_grid(hsmm_states ~ ., scale = "free")+
  xlim(c(0,50))

```




```{r hsmm sojourn}

# follicular phase from menstruation until ovulation

#gammafit(x = CYCLES$ovu)
#plot(dgamma(x = 1:40, shape = 11.84, scale = 1.5), type = "l")


sojourn = data.frame()
# menses
M_gammafit = gammafit(x = FAM_agg_sojourn$n_days[FAM_agg_sojourn$hsmm_states == "M"])
sojourn = rbind(sojourn, data.frame(shape =  as.numeric(M_gammafit$shape), scale =  as.numeric(M_gammafit$scale)))

# low E
lE_gammafit = gammafit(x = FAM_agg_sojourn$n_days[FAM_agg_sojourn$hsmm_states == "lE"])
sojourn = rbind(sojourn, data.frame(shape =  as.numeric(lE_gammafit$shape), scale =  as.numeric(lE_gammafit$scale)))

# high E
hE_gammafit = gammafit(x = pmax(1,FAM_agg_sojourn$n_days[FAM_agg_sojourn$hsmm_states == "hE"]-1))
sojourn = rbind(sojourn, data.frame(shape =  as.numeric(hE_gammafit$shape), scale =  as.numeric(hE_gammafit$scale)))

# preO
oneday_gammafit = gammafit(x = rnorm(10000, mean = 1, sd = 0.1))
sojourn = rbind(sojourn, data.frame(shape =  as.numeric(oneday_gammafit$shape), scale =  as.numeric(oneday_gammafit$scale)))

# O
sojourn = rbind(sojourn, data.frame(shape =  as.numeric(oneday_gammafit$shape), scale =  as.numeric(oneday_gammafit$scale)))

# postO
postO_gammafit = gammafit(x = rnorm(10000, mean = 2, sd = 0.1))
sojourn = rbind(sojourn, data.frame(shape =  as.numeric(postO_gammafit$shape), scale =  as.numeric(postO_gammafit$scale)))

# Lut
Lut_gammafit = gammafit(x = pmax(1,FAM_agg_sojourn$n_days[FAM_agg_sojourn$hsmm_states == "Lut"]-2))
sojourn = rbind(sojourn, data.frame(shape =  as.numeric(Lut_gammafit$shape), scale =  as.numeric(Lut_gammafit$scale)))


plot(dgamma(x = 1:40, shape = M_gammafit$shape, scale = M_gammafit$scale), type = "l", col = hsmm$states$colors[hsmm$states$abbr == "M"])
points(dgamma(x = 1:40, shape = lE_gammafit$shape, scale = lE_gammafit$scale), type = "l", col = hsmm$states$colors[hsmm$states$abbr == "lE"])
points(dgamma(x = 1:40, shape = hE_gammafit$shape, scale = hE_gammafit$scale), type = "l", col = hsmm$states$colors[hsmm$states$abbr == "hE"])
points(dgamma(x = 1:40, shape = oneday_gammafit$shape, scale = oneday_gammafit$scale), type = "l", col = hsmm$states$colors[hsmm$states$abbr == "preO"])
points(dgamma(x = 1:40, shape = oneday_gammafit$shape, scale = oneday_gammafit$scale), type = "l", col = hsmm$states$colors[hsmm$states$abbr == "O"])
points(dgamma(x = 1:40, shape = postO_gammafit$shape, scale = postO_gammafit$scale), type = "l", col = hsmm$states$colors[hsmm$states$abbr == "postO"])
points(dgamma(x = 1:40, shape = Lut_gammafit$shape, scale = Lut_gammafit$scale), type = "l", col = hsmm$states$colors[hsmm$states$abbr == "Lut"])

# P
sojourn = rbind(sojourn, data.frame(shape =  as.numeric(oneday_gammafit$shape), scale =  as.numeric(oneday_gammafit$scale)))

# PL
plot(dgamma(x = 1:(7*40), shape =2.5, scale = 20), type = "l", col = hsmm$states$colors[hsmm$states$abbr == "PL"])
sojourn = rbind(sojourn, data.frame(shape =  2.5, scale =  20))

# L
sojourn = rbind(sojourn, data.frame(shape =  as.numeric(oneday_gammafit$shape), scale =  as.numeric(oneday_gammafit$scale)))

# PB
plot(dgamma(x = 1:(7*50), shape =100, scale = 2.6), type = "l", col = hsmm$states$colors[hsmm$states$abbr == "PB"])
abline(v = 7*38)
abline(v = 7*34)
abline(v = 7*28)
sojourn = rbind(sojourn, data.frame(shape =  100, scale =  2.6))

# B
sojourn = rbind(sojourn, data.frame(shape =  as.numeric(oneday_gammafit$shape), scale =  as.numeric(oneday_gammafit$scale)))

# PP
plot(dgamma(x = 1:(7*10), shape = 45, scale = 1), type = "l", col = hsmm$states$colors[hsmm$states$abbr == "PP"])
abline(v = 7*(4:8))
sojourn = rbind(sojourn, data.frame(shape =  45, scale =  1))

# BF
plot(dgamma(x = 1:(30.5*10), shape = 5, scale = 30), type = "l", col = hsmm$states$colors[hsmm$states$abbr == "BF"])
abline(v = 30.5*(1:10))
sojourn = rbind(sojourn, data.frame(shape =  5, scale =  30))


# Ano
plot(dgamma(x = 1:100, shape = 5, scale = 8), type = "l", col = hsmm$states$colors[hsmm$states$abbr == "Ano"])
abline(v = 7*(1:10))
sojourn = rbind(sojourn, data.frame(shape =  5, scale =  8))

# STOP
stop_gammafit = gammafit(x = runif(10000, min = 15, max = 1000))
plot(dgamma(x = 1:1000, shape = 1.2, scale = 1000), type = "l", col = hsmm$states$colors[hsmm$states$abbr == "stop"])
abline(v = 30.5*(1:24))
sojourn = rbind(sojourn, data.frame(shape =  1.2, scale =  100))

hsmm$states$sojourn = sojourn

```



#### Model declaration

```{r hsmm model declaration, fig.width=15}

reprod_cycles_model =  hsmmspec(
  init = hsmm$init, 
  trans = hsmm$trans_no_names, 
  parms.emission = hsmm$emission, 
  sojourn = list(shape = hsmm$states$sojourn$shape, scale = hsmm$states$sojourn$scale, type = "gamma"), 
  dens.emission = dmvnorm.hsmm,
  rand.emission = rmvnorm.hsmm, 
  mstep = mstep.mvnorm)

sim = simulate.hsmmspec(reprod_cycles_model, nsim = 100)


sim_x = data.frame(sim$x)
colnames(sim_x) = hsmm$obs_names
sim_x$state_num = sim$s
sim_x$state_abbr = hsmm$states$abbr[sim$s]
sim_x$day = 1:nrow(sim_x)

sim_x_long = melt(sim_x, id.vars = c("state_num","state_abbr","day"))

ggplot(sim_x_long, aes(x = day, y = value))+
  geom_line()+
  geom_point(aes(col = factor(state_abbr, levels = hsmm$states$abbr)))+
  scale_color_manual(values = hsmm$states$colors)+
  facet_grid(variable ~ ., scale = "free")+
  ggtitle("Simulated sequence")

```



```{r save model}
save(reprod_cycles_model, hsmm, file = paste0(IO$output_data,"unfitted_reprod_cycles_model.Rdata"))
```




```{r stop, include=FALSE}
knitr::opts_chunk$set(eval = FALSE)
```


```{r fit and predictions}

reprod_cycles_model_ff = hsmmfit(x = sim, model = reprod_cycles_model, lock.d = TRUE, lock.transition = TRUE, maxit = 1, graphical = FALSE, debug = TRUE)

predict_sim_viterbi = predict(object = reprod_cycles_model_ff, newdata = sim, method = "viterbi")
table(sim$s,predict_sim_viterbi$s)


predict_sim_smoothed = predict(object = reprod_cycles_model_ff, newdata = sim, method = "smoothed")
table(sim$s,predict_sim_smoothed$s)

```




```{r accuracy}

sum(sim$s == predict_sim_viterbi$s)/length(sim$s)

sum(sim$s == predict_sim_smoothed$s)/length(sim$s)

```




```{r hsmm simulations viz, fig.width=15}


ggplot(sim_x_long, aes(x = day, y = value))+
  geom_line()+
  geom_point(aes(col = factor(state_abbr, levels = hsmm$states$abbr)))+
  scale_color_manual(values = hsmm$states$colors)+
  facet_grid(variable ~ ., scale = "free")+
  ggtitle("Simulated sequence")


states_df = data.frame(day = 1:length(sim$s), simulated = sim$s, predicted_vit = predict_sim_viterbi$s, predicted_smooth = predict_sim_smoothed$s)
states_df = melt(states_df, id.vars = "day")
states_df$state = factor(hsmm$states$abbr[states_df$value], levels = hsmm$states$abbr)

ggplot(states_df, aes(x = day, y = state, group = variable, col = variable))+
  geom_line()+
  scale_color_manual(values = hsmm$states$colors)+
  theme(legend.position = "bottom")+
  ggtitle("Simulated + predicted states")



```

```{r comparison of the mus, fig.width=12}


MUs = as.data.frame(matrix(unlist(reprod_cycles_model$parms.emission$mu), nrow = hsmm$n_states, ncol = hsmm$n_obs, byrow = TRUE, dimnames = list(c(hsmm$states$abbr), c(hsmm$obs_names))))
MUs$states = rownames(MUs)
MUs$model = "original"

fitted_MUs = as.data.frame(matrix(unlist(reprod_cycles_model_ff$model$parms.emission$mu), nrow = hsmm$n_states, ncol = hsmm$n_obs, byrow = TRUE, dimnames = list(c(hsmm$states$abbr), c(hsmm$obs_names))))
fitted_MUs$states = rownames(fitted_MUs)
fitted_MUs$model = "fitted"

MUs = rbind(MUs, fitted_MUs)
MUs = melt(MUs, id.vars = c("states","model"))
MUs$states = factor(MUs$states, levels = hsmm$states$abbr)

ggplot(MUs, aes(x = states, y =  value, col = states,  size = model))+
  geom_point()+
  facet_wrap(variable ~ ., scale = "free")+
  scale_size_discrete(range = c(1,2))+
  scale_color_manual(values = hsmm$states$colors)

```

