---
title: "Misc"
author: "Laura Symul"
date: "5/7/2019"
output: html_document
---




```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```





## Is something else predictive of pregnancy outcomes?

### Detect ovulation in cycles without positive pregnancy tests

* Use HMM model (adapt it to include prior knowledge and LH tests)

* Label days table

* Aggregate cycles table with

    + ovulation day + uncertainty
  
    + temperature shift
  
* Aggregate users table with 

    + average, minimum and maximum temperature shift for cycles before first positive preg test


```{r figures cycle length histogram}

cycles = read_feather(path = paste0(IO$output_data, "cycles.feather"))
pregnancies = read_feather(path = paste0(IO$output_data, "pregnancies.feather"))


lt_weeks = 84

g_hist_lt = ggplot(pregnancies, 
                   aes(x = preg_duration, fill = reprod_obj)) + 
  geom_vline(xintercept = dict$pregnancy_timeline$duration_in_days[dict$pregnancy_timeline$duration_in_weeks <= lt_weeks], 
             col = "gray", linetype = 2)+
  geom_histogram(aes(y = ..density..), binwidth = 7, position = "identity", alpha = 0.5)+ # 
  scale_x_continuous(breaks = viz$xaxis_m*28, minor_breaks = viz$xaxis_s*7,  
                     labels = viz$xaxis_m*4, limits = c(0,lt_weeks*7), expand = c(0,0))+
  ylab("% of cycles")+ xlab("pregnancy duration (in weeks)")+ # ylab("% of cycles")
  scale_fill_manual(name = "Reprod. Obj", values = c("red","royalblue1","turquoise"))+ 
  theme(legend.position = "bottom")+
  guides(fill = FALSE)
#g_hist_lt



st_weeks = 10

g_hist_st = ggplot(cycles[cycles$preg_test_class != "pregnant",], aes(x = cycle_length, fill = preg_test_class, group = preg_test_class)) +   
  geom_vline(xintercept = dict$pregnancy_timeline$duration_in_days[dict$pregnancy_timeline$duration_in_weeks <= st_weeks], 
             col = "gray", linetype = 2)+
  geom_histogram(aes(y = ..density.. ), binwidth = 1, position = "identity", alpha = 0.5)+
  scale_x_continuous(breaks = viz$xaxis_m*28, minor_breaks = viz$xaxis_s*7,  
                     labels = viz$xaxis_m*4, limits = c(0,st_weeks*7), expand = c(0,0))+
  ylab("density")+ xlab("cycle duration (in weeks)")+ # ylab("% of cycles")
  scale_fill_manual(name = "Cycle label",values = c("tomato","lightgoldenrod4","royalblue1"))+ 
  theme(legend.position = "right")
#facet_grid(preg_test_class ~ .)
#g_hist_st


g_inset = ggplotGrob(g_hist_st +
                       theme(plot.background = element_rect(colour = "gray40")))


g = g_hist_lt + annotation_custom(
  grob = g_inset,
  xmin = 18*7,
  xmax = Inf,
  ymin = 0.005,
  ymax = Inf
)

g

ggsave(filename = paste0(IO$panels, "cycle or pregnancy duration.pdf"), g, width = 7, height = 5)

```


```{r figures pregnancy outcomes}

pregnancies = read_feather(path = paste0(IO$output_data, "pregnancies.feather"))


agg_preg_outcomes = aggregate(pregnancy_id ~ preg_outcome + preg_outcome_cat, 
                              pregnancies[pregnancies$preg_type == 1,], lu) %>% 
  set_colnames(c("preg_outcome","preg_outcome_cat","n_preg"))  %>%
  mutate(perc_preg = n_preg/sum(n_preg))

agg_preg_outcomes_max = aggregate(perc_preg ~ preg_outcome, agg_preg_outcomes, sum )

g = ggplot() + 
  geom_bar(data = agg_preg_outcomes, 
           aes(x = preg_outcome, y = perc_preg, fill = preg_outcome_cat), stat = "identity")+
  geom_text(data = agg_preg_outcomes_max, 
            aes(x = preg_outcome, 
                y = perc_preg, 
                label = paste0(round(100*perc_preg),"%"), 
                col = preg_outcome), 
            fill = NULL, vjust = -0.5)+
  xlab("Pregnancy outcome")+ ylab("% cycles")+
  scale_fill_manual(values = dict$pregnancy_outcomes$colors)+
  scale_color_manual(values = dict$pregnancy_timeline$colors[-which(dict$pregnancy_timeline$abbreviation == "TB noBF")])+
  scale_y_continuous(labels=percent)+
  guides(fill = FALSE, col = FALSE)

g


ggsave(filename = paste0(IO$panels, "pregnancy outcomes.pdf"), g, width = 5, height = 5)

table(cycles$preg_outcome[j])
x = round(table(cycles$preg_outcome[j])/sum(table(cycles$preg_outcome[j])) * 100 ,2)
x

```





```{r figures pregnancy outcomes predictors}

pregnancies$reprod_obj = factor(pregnancies$reprod_obj, levels = c("unknown","avoid_preg","get_preg"))

multinom_res = multinom(preg_outcome ~ current_age + reprod_obj + cycle_nb,
                        data = pregnancies[pregnancies$preg_type == 1,])

multinom_res
```


```{r PL_descr type0 and type1 users}

type0_users = (users$first_cycle_preg == 0) | (users$n_cycles_after_last_preg == 0) | is.na(users$first_cycle_preg)
type1_users = !type0_users

users$is_type_1_user = type1_users


write_feather(users, path = paste0(IO$output_data, "users.feather"))
file.copy(from = paste0(IO$output_data, "users.feather"), to = paste0(IO$tmp_data, "users_with_type.feather"), overwrite = TRUE)

```


```{r reprod_obj reproductive objective per pregnancy}

cycles_tmp = cycles
cycles_tmp$before_fist_preg_test = cycles$cycle_nb < users$first_cycle_preg[match(cycles$user_id, users$user_id)]

reprod_obj_users =  ddply(cycles_tmp[which(cycles_tmp$before_fist_preg_test),], 
                          .(user_id), 
                          .fun = summarize,
                          avg_reprod_score = mean(reprod_objective_score, na.rm = TRUE),
                          median_reprod_score = median(reprod_objective_score, na.rm = TRUE),
                          n_na_reprod_score = sum(is.na(reprod_objective_score)),
                          n_insemination = sum(n_insemination)
)


column_names = colnames(reprod_obj_users)
column_names = column_names[-which(column_names %in% colnames(users))]
m = match(users$user_id, reprod_obj_users$user_id)
for(column  in column_names){
  eval(parse(text = paste0("users$",column,"= reprod_obj_users$",column,"[m]")))
  #eval(parse(text = paste0("users$",column,"[is.na(users$",column,")]= 0")))
}


users$reprod_obj = ifelse(users$n_insemination > 0, "conception",
                          ifelse(users$n_na_reprod_score > (users$first_cycle_preg/2), "unknown",
                                 ifelse((users$median_reprod_score < 0.05)&(users$avg_reprod_score < 0.1),
                                        "contraception","conception")))


save(users, file = paste0(IO$output_data, "users.Rdata"))
file.copy(from = paste0(IO$output_data, "users.Rdata") , to = paste0(IO$tmp_data, "users_with_reprod_obj.Rdata"), overwrite = TRUE)

```


```{r figures cycle lengths predictor - old}

load(file = paste0(IO$output_data,"users.Rdata"), verbose = TRUE)

users$any_PL = ifelse(users$n_PL>0, "Yes", ifelse(users$n_LB>0,"No",NA))

u = users[which(!is.na(users$any_PL)),]


g = ggplot(u, aes(x = cycle_length_before_preg_median, fill = any_PL))+
  geom_histogram(aes(y = ..density..), col = NA, alpha = 0.5, position = "identity", binwidth = 1)+
  scale_x_continuous(breaks = viz$xaxis_j, limits = c(14,70))+
  scale_fill_manual(name = "experienced any preg. loss", values = c("blue","red"))+
  xlab("median cycle length before first positive preg. test")+
  theme(legend.position = "top")

g


ggsave(filename = paste0(IO$panels, "median_cycle_length_before_first_preg.pdf"), g, width = 5, height = 5)




g = ggplot(u, aes(x = cycle_length_before_preg_sd, fill = any_PL))+
  geom_histogram(aes(y = ..density..), col = NA, alpha = 0.5, position = "identity", binwidth = 0.5)+
  scale_x_continuous(breaks = viz$xaxis_j, limits = c(0,42))+
  scale_fill_manual(name = "experienced any preg. loss", values = c("blue","red"))+
  xlab("standard deviation in cycle length before 1st pos. preg. test")+
  theme(legend.position = "top")
g

ggsave(filename = paste0(IO$panels, "sd_cycle_length_before_first_preg.pdf"), g, width = 5, height = 5)




qqplot(x=  u$cycle_length_before_preg_sd[which(u$any_PL == "Yes")], 
       y = u$cycle_length_before_preg_sd[which(u$any_PL == "No")], 
       pch = 16, cex = 0.5, col = rgb(0,0,0,0.3),
       xlim = c(0,50), ylim = c(0,50))
abline(a = 0, b = 1)



qqplot(x=  u$cycle_length_before_preg_median[which(u$any_PL == "Yes")], 
       y = u$cycle_length_before_preg_median[which(u$any_PL == "No")], 
       pch = 16, cex = 0.5, col = rgb(0,0,0,0.3),
       xlim = c(0,91), ylim = c(0,91))
abline(a = 0, b = 1)


```

```{r data_prep save the original input files reference into users table}

input_files = aggregate(input_file_id ~ user_id, input_files, function(x){paste0(unique(sort(x)),collapse = "|")})
users$input_files = input_files$input_file_id[match(users$user_id, input_files$user_id)]

write_feather(users, path = paste0(IO$output_data,"users.feather"))
file.copy(from = paste0(IO$output_data,"users.feather"), to = paste0(IO$tmp_data,"users_with_original_file_id.feather"), overwrite = TRUE)

```


```{r data_prep checking cycles table, eval = FALSE}

# load(paste0(IO$output_data,"users.Rdata"), verbose = TRUE)

cycles_input_folder = paste0(IO$input_data,"Cycles/")
cycles_files = list.files(cycles_input_folder)

cycles = foreach(file  = cycles_files) %dopar%
{
  file  = cycles_files[3]
  cycles = read.csv(paste0(cycles_input_folder,file), stringsAsFactors = FALSE)
  dim(cycles)
  colnames(cycles)
  cycles$user_id = cycles$account
  j = which(cycles$user_id %in% users$user_id)
  length(j)
  return(cycles[j,])
}

dim(cycles)

```






```{r}

    
    this_user_day = days[which((days$user_id == user_id) & (days$menstruation > 0)),]
    date_last_bleeding = this_user_day$date[1] - 10
    time_between_bleeding = as.numeric(diff(c(date_last_bleeding, this_user_day$date)))
    this_user_day$menstruation_next_day = this_user_day$menstruation[match(this_user_day$date, (this_user_day$date-1))]
    this_user_day$menstruation_next_day[is.na(this_user_day$menstruation_next_day)] = 0
    sum_bleeding_2_days = this_user_day$menstruation + this_user_day$menstruation_next_day
    this_user_day$cycle_start_l = (time_between_bleeding > 7) & (sum_bleeding_2_days >= 2)
    days$is_first_day[match(this_user_day$day_id[which(this_user_day$cycle_start_l)],days$day_id)] = TRUE
```



## Identifying pregnancy starts and ends

### Pregnancy start

If a positive pregnancy test is logged early in a cycle, it probably reflects a conception which happened at the previous cycle. The current cycle thus needs to be merged with the previous cycle and the merged cycle is labeled as a pregnancy.


```{r identifying pregnancy starts}

cycles = read_feather(path = paste0(IO$output_data,"cycles.feather"))

ggplot(cycles[cycles$n_pos_preg_test>0,], aes(x = day_first_pos_preg_test))+
  geom_histogram(binwidth = 1)+xlim(c(0,100))

cycle_ids = unique(cycles$cycle_id[cycles$n_pos_preg_test > 0])

foreach(cycle_id = cycle_ids) %do% {
  k = which(cycles$cycle_id == cycle_id)
  j = which((cycles$user_id == cycles$user_id[k]) & (cycles$cycle_nb %in% (cycles$cycle_nb[k]-1:5)))
  if(length(j)<3){
    median_cycle_length = 29
  }else{
    median_cycle_length = median(cycles$cycle_length[j])
  }
  cycleday_limit_pos_preg_test = median_cycle_length - 5
  if(cycles$day_first_pos_preg_test[k]<cycleday_limit_pos_preg_test){ # got pregnant at previous cycle
    # Merge the 2 cycles
    
  }
  
}

```





```{r data_prep filtering users}

j = which(
  (users$first_cycle_preg >= 5)&
    (users$shortest_cycle_before_first_pos_preg > 15) &
    ((users$n_cycles_after_first_preg >=2) | (users$n_days_obs_after_first_preg >= 20)))

# users
users = users[j,]
save(users, file = paste0(IO$output_data,"users.Rdata"))
file.copy(from = paste0(IO$output_data,"users.Rdata"), to = paste0(IO$tmp_data,"users_filtered.Rdata"), overwrite = TRUE)

# cycles
cycles = cycles[which(cycles$user_id %in% users$user_id),]
save(cycles, file = paste0(IO$output_data,"cycles.Rdata"))
file.copy(from = paste0(IO$output_data,"cycles.Rdata"), to = paste0(IO$tmp_data,"cycles_filtered.Rdata"), overwrite = TRUE)

# days
days_folder = paste0(IO$output_data,"Days/")

cl = makeCluster(par$n_cores)
registerDoParallel(cl)

days_files = list.files(days_folder)

days = foreach(file  = days_files, .combine = rbind) %dopar%
{
  load(paste0(days_folder,file), verbose = TRUE)
  colnames(days)
  dim(days)
  j = which(days$user_id %in% users$user_id)
  days = days[j,]
  return(days)
}

stopImplicitCluster()

save(days, file = paste0(IO$output_data,"days.Rdata"))
file.copy(from = paste0(IO$output_data,"days.Rdata"), to = paste0(IO$tmp_data,"days_filtered.Rdata"), overwrite = TRUE)

```




```{r}
 obs = data.frame(date = dates, 
                   bleeding = bleeding, 
                   temp = temp, 
                   mucus_tracked = mucus$mucus_tracked,
                   mucus_score = mucus$mucus_score,
                   mucus = mucus$mucus,
                   LH = LH, 
                   preg_test = preg_test, 
                   gap = gap, 
                   anylog = anylog)
```


```{r}


input_folder = paste0(IO$output_data,"Days_long/")
days_files = paste0("days_",1:10,".feather")

foreach(file = days_files) %do% {
  cat(file, "\n")
  days = read_feather(paste0(input_folder,file))
  forward_agg =  ddply(days[which(days$cycleday <= 28),],
                       .(cycleday),
                       .fun = summarize,
                       cycleday_type = "cycleday",
                       temp_mean = mean(temp, na.rm = TRUE),
                       temp_sd = sd(temp, na.rm = TRUE),
                       mucus_mean = mean(mucus, na.rm = TRUE),
                       mucus_sd = sd(mucus, na.rm = TRUE)
                       
  )
  
  backward_agg =  ddply(days[which(days$cycleday_from_end >= -28),],
                        .(cycleday_from_end),
                        .fun = summarize,
                        cycleday_type = "cycleday_from_end",
                        temp_mean = mean(temp, na.rm = TRUE),
                        temp_sd = sd(temp, na.rm = TRUE),
                        mucus_mean = mean(mucus, na.rm = TRUE),
                        mucus_sd = sd(mucus, na.rm = TRUE)
  )
  colnames(backward_agg)
  
  g = ggplot(backward_agg, aes(x = cycleday_from_end))+
    geom_line(aes(y = mucus_mean))+
    geom_line(aes(y = temp_mean), col = "red")+
    geom_ribbon(aes(ymin = mucus_mean - mucus_sd/2, ymax = mucus_mean + mucus_sd/2), alpha = 0.2)+
    geom_ribbon(aes(ymin = temp_mean - temp_sd/2, ymax = temp_mean + temp_sd/2), alpha = 0.2, fill = "red")
  
  print(g)
  
  g = ggplot(forward_agg, aes(x = cycleday))+
    geom_line(aes(y = mucus_mean))+
    geom_line(aes(y = temp_mean), col = "red")+
    geom_ribbon(aes(ymin = mucus_mean - mucus_sd/2, ymax = mucus_mean + mucus_sd/2), alpha = 0.2)+
    geom_ribbon(aes(ymin = temp_mean - temp_sd/2, ymax = temp_mean + temp_sd/2), alpha = 0.2, fill = "red")
  
  print(g)
  
}
```


```{r}

      # if not enough of both -> 
      #         - rough estimation of ovulation date from temp shift and from mucus peak
      #         - interpolate + impute
      
      if((n_mucus >= (this_cycle_length - 10)) | (n_temp >= (this_cycle_length - 10))){
        temp = interpolate(temp)
        mucus = interpolate(mucus)
      }else{
        # is there a temperature shift
        dc = d_this_cycle[d_this_cycle$variable == "temp",]
        dc$temperature = dc$value
        temp_phases = identify_temp_phases(dc)
        jt = temp_phases$cycleday
        if((jt>0) & (temp_phases)){ # there is a temperature shift
          # check if there is high mucus a few days around the temperature shift day
          if(any(mucus[max(1,jt-5):min(length(mucus),jt+3)] > 0.2, na.rm = TRUE)){
            ovu_day = jt
          }else{
              
            }
        
          
        }
        
        
        # is there a mucus peak
        jm = which(mucus > 0.2)
        jm = jm[length(jm)]
        
        # are the temp shift and the mucus peak within 5 days from each other?
        if((jt>0) & (temp_phases)  & (length(jm)>0) & (abs(jt - jm) <= 5)){ ovu_day = mean(c(jt,jm))}
        if(jt > 0 ){ovu}else{
          if(this_cycle_length  %in% (median_cycle_length+(-10:10))) ovu_day = this_cycle_length - 13 
          if(this_cycle$cycle_length  > (median_cycle_length-10)) ovu_day = median_cycle_length - 13
        }
        
      }
      
     
      if(temp_phases$delta_t >= 0.4){
        
      }
      # is there a mucus peak
      
      
    }
    
    if(this_cycle$cycle_length  %in% (median_cycle_length+(-10:10))){
      
    }else if(this_cycle$cycle_length  > (median_cycle_length-10)){
      
    }else if(this_cycle$cycle_length  < (median_cycle_length-10)){
      
    }
    
    
    
```




```{r tmp test, include = FALSE}

n_foll = 6
n_lut = 2
t_shift = 0.5

temp = c(rnorm(n_foll, m = 0, sd = t_shift/4), rnorm(n_lut, m = t_shift, sd = t_shift/4))
#plot(temp, type = "b")

temp_norm = temp - mean(temp)

est_t_shift = mean(temp_norm[temp_norm>0]) -  mean(temp_norm[temp_norm<=0])
est_t_shift

plot(temp_norm, type = "b", main = round(est_t_shift, 3))
abline(h = 0)


```